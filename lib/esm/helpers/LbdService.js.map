{"version":3,"sources":["../../../src/helpers/LbdService.ts"],"names":["LBDService","verbose","constructor","session","fetch","accessService","AccessService","dataService","DataService","validateWebId","webId","lbdLoc","getProjectRegistry","length","getAllProjects","aggregator","data","headers","then","t","json","myProjects","LDP","contains","map","i","stakeholder","myEngine","q","LBD","hasProjectRegistry","location","query","sources","res","bindings","bind","get","value","catch","err","undefined","createProjectRegistry","url","publiclyAccessible","q0","sparqlUpdate","q1","Aggregator","accessRights","actor","read","append","write","control","setResourceAccess","ResourceType","CONTAINER","error","console","log","removeProjectRegistry","deleteContainer"],"mappings":"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","sourcesContent":["import AccessService from \"./access-service\";\nimport { urlJoin } from \"url-join-ts\";\nimport DataService from \"./data-service\";\nimport { computeChecksumMd5 } from \"./utils\";\nimport { newEngine, IQueryResultBindings } from \"@comunica/actor-init-sparql\";\n// Import from \"@inrupt/solid-client\"\nimport {\n  createSolidDataset,\n  buildThing,\n  getSolidDataset,\n  createThing,\n  setThing,\n  setUrl,\n  addUrl,\n  getThingAll,\n  getUrlAll,\n  setDatetime,\n  saveSolidDatasetAt,\n} from \"@inrupt/solid-client\";\nimport { extract } from \"./functions\";\nimport { RDF, SCHEMA_INRUPT, DCAT, LDP } from \"@inrupt/vocab-common-rdf\";\nimport LBD from \"./vocab/lbd\";\nimport { AccessRights, ResourceType } from \"./BaseDefinitions\";\nimport { Session as BrowserSession } from \"@inrupt/solid-client-authn-browser\";\nimport { Session as NodeSession} from \"@inrupt/solid-client-authn-node\";\n\nexport default class LBDService {\n  public fetch;\n  public verbose: boolean = false;\n  public accessService: AccessService;\n  public dataService: DataService;\n  private session: BrowserSession | NodeSession\n  \n  constructor(session: BrowserSession | NodeSession, verbose: boolean = false) {\n    this.session = session\n    this.fetch = session.fetch;\n    this.verbose = verbose;\n    this.accessService = new AccessService(session.fetch);\n    this.dataService = new DataService(session.fetch);\n  }\n\n  /////////////////////////////////////////////////////////\n  ////////////////////// PREPARATION //////////////////////\n  /////////////////////////////////////////////////////////\n  public async validateWebId(webId: string) {\n    const lbdLoc = await this.getProjectRegistry(webId)\n    if (lbdLoc && lbdLoc.length > 0) {\n        return true\n    }\n    return false\n  }\n\n  public async getAllProjects(aggregator) {\n    const data = await this.fetch(aggregator, { headers: { \"Accept\": \"application/ld+json\" } }).then(t => t.json())\n    const myProjects = extract(data, aggregator)[LDP.contains].map(i => i[\"@id\"])\n    return myProjects\n  }\n\n  public async getProjectRegistry(stakeholder: string): Promise<string|undefined> {\n      const myEngine = newEngine();\n      const q = `select ?loc where {<${stakeholder}> <${LBD.hasProjectRegistry}> ?loc}`;\n      const location = await myEngine\n        .query(q, { sources: [stakeholder], fetch: this.fetch })\n        .then((res: IQueryResultBindings) => res.bindings())\n        .then((bind: any) => bind.map(i => i.get(\"?loc\").value))\n        .catch((err: Error) => {throw err});\n    if (location && location.length > 0) {\n        return location[0];\n    } else {\n        return undefined\n    }\n  }\n\n  public async createProjectRegistry(stakeholder: string, url: string, publiclyAccessible: boolean = true): Promise<string> {\n    try {\n      const q0 = `INSERT DATA {\n          <${stakeholder}> <${LBD.hasProjectRegistry}> <${url}> .\n        }`;\n      await this.dataService.sparqlUpdate(stakeholder, q0);\n\n      // create the LBD registry (container / Aggregator)\n      const q1 = `INSERT DATA {\n        <${url}> a <${LBD.Aggregator}> .\n      }`;\n    \n      // the updates immediately creates the container\n      await this.dataService.sparqlUpdate(url, q1);\n\n      let accessRights: AccessRights\n      let actor: string | undefined\n      if (publiclyAccessible) {\n        accessRights = { read: true, append: false, write: false, control: false }\n      } else {\n        accessRights = { read: true, append: true, write: true, control: true }\n        actor = stakeholder\n      }\n      await this.accessService.setResourceAccess(url, accessRights, ResourceType.CONTAINER, actor)\n      return url;\n    } catch (error) {\n      console.log(`error`, error);\n      throw error;\n    }\n  }\n\n  public async removeProjectRegistry(stakeholder: string, url: string) {\n    try {\n      const q0 = `DELETE {<${stakeholder}> <${LBD.hasProjectRegistry}> <${url}> .}\n      WHERE {<${stakeholder}> <${LBD.hasProjectRegistry}> ?reg .}\n      `;\n      await this.dataService.sparqlUpdate(stakeholder, q0);\n      await this.dataService.deleteContainer(url, true)\n    } catch (error) {\n      console.log(`error`, error);\n      throw error;\n    }\n  }\n}\n"],"file":"LbdService.js"}