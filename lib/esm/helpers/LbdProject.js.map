{"version":3,"sources":["../../../src/helpers/LbdProject.ts"],"names":["LbdProject","constructor","fetch","accessPoint","verbose","endsWith","localProject","projectId","split","length","accessService","AccessService","dataService","DataService","lbdService","LBDService","queryEngine","checkExistence","status","method","then","result","init","data","headers","i","json","create","makePublic","existingPartialProjects","local","push","createContainer","createRegistryContainer","LBD","hasDatasetRegistry","hasReferenceRegistry","hasServiceRegistry","part","addPartialProject","q0","aggregates","sparqlUpdate","addStakeholder","webId","accessRights","read","append","write","control","setResourceAccess","ResourceType","CONTAINER","delete","deleteContainer","findAllPartialProjects","projects","query","sources","bindings","map","r","get","value","findPartialProject","repo","getProjectRegistry","partialProjectOfStakeholder","res","Error","addPartialProjectByStakeholder","partialProjectUrl","containerName","property","containerUrl","addDataset","options","id","subject","datasetRegistry","datasetUrl","theDataset","LbdDataset","deleteDataset","ds","deleteDatasetById","datasetId","addConcept","referenceRegistry","ref","LbdConcept","deleteConcept","url","parts","pop","join","console","log","addAlias","getConcept","queryProject"],"mappings":"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","sourcesContent":["import AccessService from \"./access-service\";\nimport DataService from \"./data-service\";\nimport LbdConcept from './LbdConcept'\nimport { newEngine, IQueryResultBindings, ActorInitSparql } from \"@comunica/actor-init-sparql\";\nimport LbdDataset from \"./LbdDataset\"\nimport LBD from \"./vocab/lbd\";\nimport { AccessRights, ResourceType } from \"./BaseDefinitions\";\nimport LBDService from \"./LbdService\";\nimport {extract} from \"jsonld-remote\"\nimport {v4} from \"uuid\"\n\nexport default class LbdProject {\n  public fetch;\n  public verbose: boolean = false;\n  public accessService: AccessService;\n  public dataService: DataService;\n  public lbdService: LBDService;\n  public projectId: string;\n  public accessPoint: string;\n  public data: object[];\n\n  // include queryEngine to allow caching of querydata etc.\n  public queryEngine: ActorInitSparql;\n  public localProject: string;\n\n  constructor(fetch: any, accessPoint: string, verbose: boolean = false) {\n    if (!accessPoint.endsWith(\"/\")) accessPoint += \"/\"\n\n    this.fetch = fetch;\n    this.accessPoint = accessPoint;\n    this.localProject = accessPoint + \"local/\"\n    this.verbose = verbose;\n    this.projectId = accessPoint.split('/')[accessPoint.split(\"/\").length  - 2];\n    this.accessService = new AccessService(fetch);\n    this.dataService = new DataService(fetch);\n    this.lbdService = new LBDService(fetch);\n    this.queryEngine = newEngine();\n  }\n\n  public async checkExistence() {\n    const status = await this.fetch(this.accessPoint, {method: \"HEAD\"}).then(result => result.status)\n    if (status === 200) {\n      return true\n    } else {\n      return false\n    }\n  }\n\n  public async init() {\n    const data = await this.fetch(this.localProject, {headers: {\"Accept\": \"application/ld+json\"}}).then(i => i.json())\n    this.data = data\n    return data\n  }\n\n  // initialise a project\n  public async create(\n    makePublic: boolean = false,\n    existingPartialProjects: string[] = []\n  ) {\n    const local = this.accessPoint + 'local/'\n    existingPartialProjects.push(local)\n\n    // create global access point\n    await this.dataService.createContainer(this.accessPoint, makePublic)\n    await this.dataService.createContainer(local, makePublic)\n\n    // create different registries\n    await this.createRegistryContainer(\"datasets/\", makePublic, LBD.hasDatasetRegistry)\n    await this.createRegistryContainer(\"references/\", makePublic, LBD.hasReferenceRegistry)\n    await this.createRegistryContainer(\"services/\", makePublic, LBD.hasServiceRegistry)\n\n    for (const part of existingPartialProjects) {\n        await this.addPartialProject(part)\n    }\n\n    await this.init()\n  }\n\n  public async addPartialProject(part: string) {\n    const q0 = `INSERT DATA {\n        <${this.accessPoint}> <${LBD.aggregates}> <${part}> .\n        }`\n    await this.dataService.sparqlUpdate(this.accessPoint, q0)\n  }\n\n  public async addStakeholder(webId: string, accessRights: AccessRights = {read: true, append: false, write: false, control: false}) {\n    await this.accessService.setResourceAccess(this.accessPoint, accessRights, ResourceType.CONTAINER, webId)\n  }\n\n  public async delete() {\n      await this.dataService.deleteContainer(this.accessPoint, true)\n  }\n\n  public async findAllPartialProjects() {\n    const projects = await this.queryEngine.query(`SELECT ?proj WHERE {<${this.accessPoint}> <${LBD.aggregates}> ?proj}`, {sources: [this.accessPoint], fetch: this.fetch}).then((i: any) => i.bindings()).then(i => i.map(r => r.get('?proj').value))\n    return projects\n  }\n\n  public async findPartialProject(webId: string) {\n    const repo = await this.lbdService.getProjectRegistry(webId)\n    const partialProjectOfStakeholder = repo + this.projectId + '/local/'\n    const status = await this.fetch(partialProjectOfStakeholder, {method: \"HEAD\"}).then(res => res.status)\n    if (status === 200) {\n        return partialProjectOfStakeholder\n    } else {\n        throw new Error(`UNAUTHORIZED: This repository does not exist or you don't have the required access rights`)\n    }\n  }\n\n  public async addPartialProjectByStakeholder(webId: string) {\n    const partialProjectUrl = await this.findPartialProject(webId)\n    await this.addPartialProject(partialProjectUrl)\n    return partialProjectUrl\n  }\n\n  private async createRegistryContainer(containerName, makePublic, property) {\n    if (!containerName.endsWith('/')) containerName += \"/\"\n\n    const containerUrl = this.localProject + containerName\n    await this.dataService.createContainer(containerUrl, makePublic)\n    const q0 = `INSERT DATA {\n        <${this.localProject}> <${property}> <${containerUrl}> .\n      }`;\n    await this.dataService.sparqlUpdate(this.localProject, q0)\n  }\n\n  /////////////////////////////////////////////////////////\n  /////////////////////// DATASETS ////////////////////////\n  /////////////////////////////////////////////////////////\n\n  /**\n   * \n   * @param makePublic \n   * @param id\n   * @param options Optional - Object containing metadata about the dataset to be created. e.g: {[RDFS.label]: \"theLabel\"}\n   * @returns \n   */\n  public async addDataset(\n    options: object = {},\n    makePublic: boolean = false,\n    id: string = v4()\n  ): Promise<LbdDataset> {\n    const subject = extract(this.data, this.localProject)\n    const datasetRegistry = subject[LBD.hasDatasetRegistry][0][\"@id\"]\n    const datasetUrl = datasetRegistry + id + \"/\"\n    const theDataset = new LbdDataset(this.fetch, datasetUrl)\n    await theDataset.create(options, makePublic)\n    return theDataset\n  }\n\n  public async deleteDataset(\n    datasetUrl: string\n  ) {\n    if (!datasetUrl.endsWith('/')) datasetUrl += \"/\"\n    const ds = new LbdDataset(this.fetch, datasetUrl)\n    await ds.delete()\n  }\n\n  public async deleteDatasetById(\n    datasetId: string\n  ) {\n    const subject = extract(this.data, this.localProject)\n    const datasetRegistry = subject[LBD.hasDatasetRegistry][0][\"@id\"]\n    const datasetUrl = datasetRegistry + datasetId + \"/\"\n    const ds = new LbdDataset(this.fetch, datasetUrl)\n    await ds.delete()\n  }\n\n  /////////////////////////////////////////////////////////\n  ////////////////////// REFERENCES////////////////////////\n  /////////////////////////////////////////////////////////\n\n  // get all references related to a specific abstract Concept\n  public async addConcept(): Promise<LbdConcept> {\n    const subject = extract(this.data, this.localProject)\n    const referenceRegistry = subject[LBD.hasReferenceRegistry][0][\"@id\"]\n    const ref = new LbdConcept(this.fetch, referenceRegistry)\n    await ref.create()\n    return ref\n  }\n\n  public async deleteConcept(url: string) {\n    const parts = url.split(\"/\")\n    const id = parts.pop()\n    const referenceRegistry = parts.join(\"/\")\n    console.log('id, referenceRegistry', id, referenceRegistry);\n    const ref = new LbdConcept(this.fetch, referenceRegistry, id)\n    await ref.delete()\n  }\n\n\n  // register an alias for an existing concept\n  public async addAlias() {}\n\n  // get the abstract Concept related to a dataset/distribution + id\n  public async getConcept() {}\n\n  /////////////////////////////////////////////////////////\n  /////////////////////// QUERY ////////////////////////\n  /////////////////////////////////////////////////////////\n  public async queryProject() {\n    // if there is a satellite\n\n    // if there is no satellite\n  }\n\n\n  \n\n}\n\n"],"file":"LbdProject.js"}